<h1 id="iptables"><a aria-hidden="true" class="anchor-heading" href="#iptables"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Iptables</h1>
<h1 id="overview"><a aria-hidden="true" class="anchor-heading" href="#overview"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Overview</h1>
<ul>
<li>iptables - administration tool for IPv4 packet filtering and NAT</li>
</ul>
<h1 id="synopsis"><a aria-hidden="true" class="anchor-heading" href="#synopsis"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Synopsis</h1>
<pre><code>iptables [-t table] -[AD] chain rule-specification [options]
</code></pre>
<h1 id="options"><a aria-hidden="true" class="anchor-heading" href="#options"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Options</h1>
<h2 id="flags"><a aria-hidden="true" class="anchor-heading" href="#flags"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Flags</h2>
<ul>
<li><code>-t | --table &#x3C;table></code>: This option specifies the packet matching table which the command should operate on.</li>
</ul>
<h2 id="tables"><a aria-hidden="true" class="anchor-heading" href="#tables"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Tables</h2>
<p>The tables are as follows:</p>
<p><code>filter</code>:
This is the <strong>default table</strong> (if no <code>-t</code> option is passed).</p>
<ul>
<li>INPUT (for packets destined to local sockets)</li>
<li>FORWARD (for packets being routed through the box)</li>
<li>OUTPUT (for locally-generated packets)</li>
</ul>
<p><code>nat</code>:
This table is consulted when a packet that creates a new connection is encountered.</p>
<ul>
<li>PREROUTING (for altering packets as soon as they come in)</li>
<li>OUTPUT (for altering locally-generated packets before routing)</li>
<li>POSTROUTING (for altering packets as they are about to go out)</li>
</ul>
<p><code>mangle</code>:
This table is used for specialized packet alteration. Until kernel 2.4.17 it had two built-in chains: </p>
<ul>
<li>PREROUTING (for altering incoming packets before routing)</li>
<li>OUTPUT (for altering locally-generated packets before routing). </li>
</ul>
<p>Since kernel 2.4.18, three other built-in chains are also supported: </p>
<ul>
<li>INPUT (for packets coming into the box itself)</li>
<li>FORWARD (for altering packets being routed through the box)</li>
<li>POSTROUTING (for altering packets as they are about to go out)</li>
</ul>
<p><code>raw</code>:
This table is used mainly for configuring exemptions from connection tracking in combination with the NOTRACK target. It registers at the netfilter hooks with higher priority and is thus called before ip_conntrack, or any other IP tables.</p>
<ul>
<li>PREROUTING (for packets arriving via any network interface)</li>
<li>OUTPUT (for packets generated by local processes)</li>
</ul>
<h1 id="examples"><a aria-hidden="true" class="anchor-heading" href="#examples"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Examples</h1>
<pre class="language-sh"><code class="language-sh">## List Rules
iptables -L --line-numbers

## List Rules in nat table
sudo iptables -t nat -L -n

## Delete a rule by number
iptables -D [CHAIN NAME] [RULE NUMBER]
## e.g. Delete 11th rule at the "FORWARD" chain.
iptables -D FORWARD 11

## Port forward to another IP
## TCP
iptables -t nat -I PREROUTING -p tcp -m tcp --dst &#x3C;node_a> --dport &#x3C;port_a>[:&#x3C;port_b>] -j DNAT --to-destination &#x3C;node_b>:&#x3C;port_a>[-&#x3C;port_b>]
iptables -t nat -A POSTROUTING -m tcp -p tcp --dst &#x3C;node_b> --dport &#x3C;port_a>[:&#x3C;port_b>] -j SNAT --to-source &#x3C;node_a>
## Not sure if need the below
iptables -A FORWARD -m tcp -p tcp --dst &#x3C;node_b> --dport &#x3C;port_a>:&#x3C;port_b> -j ACCEPT
## e.g. NodeA (192.168.0.3:31000-31999) -> NodeB (172.20.0.11:31000-31999)
iptables -t nat -I PREROUTING -p tcp -m tcp --dst 192.168.0.3 --dport 31000:31999 -j DNAT --to-destination 172.20.0.11:31000-31999
iptables -t nat -A POSTROUTING -m tcp -p tcp --dst 172.20.0.11 --dport 31000:31999 -j SNAT --to-source 192.168.0.3
iptables -A FORWARD -m tcp -p tcp --dst 172.20.0.11 --dport  31000:31999 -j ACCEPT
## Another example with masqerade: 3124 -> 1.1.1.1:3000
iptables -t nat -A PREROUTING -p tcp --dport 3124 -j DNAT --to-destination 1.1.1.1:3000
iptables -t nat -A POSTROUTING -j MASQUERADE
</code></pre>
<h1 id="other-notes"><a aria-hidden="true" class="anchor-heading" href="#other-notes"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Other Notes</h1>
<h2 id="ip-forwarding"><a aria-hidden="true" class="anchor-heading" href="#ip-forwarding"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>IP Forwarding</h2>
<p>NAT uses IP forwarding and by default itâ€™s not enabled in the kernel parameters</p>
<h3 id="check-if-ip-forwarding-is-enabled"><a aria-hidden="true" class="anchor-heading" href="#check-if-ip-forwarding-is-enabled"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Check if IP forwarding is enabled</h3>
<pre class="language-sh"><code class="language-sh">## CentOS/RHEL
sysctl net.ipv4.ip_forward
## Debian:
sudo sysctl net.ipv4.ip_forward
## Return: net.ipv4.ip_forward = 0   # where 0 means disabled
net.ipv4.ip_forward = 0
</code></pre>
<h3 id="enable-ip-forwarding"><a aria-hidden="true" class="anchor-heading" href="#enable-ip-forwarding"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Enable IP forwarding</h3>
<pre class="language-sh"><code class="language-sh">### To enable IP persistently (survives a reboot):
## CentOS/RHEL:
echo "net.ipv4.ip_forward = 1"|sudo tee /etc/sysctl.d/99-ipforward.conf
## Debian:
sudo sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g' /etc/sysctl.conf

### To activate the changes immediately afer making the aboves changes:
## CentOS/RHEL:
sudo sysctl -p /etc/sysctl.d/99-ipforward.conf
## Debian:
sudo sysctl -p
</code></pre>